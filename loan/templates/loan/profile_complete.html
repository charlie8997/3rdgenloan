{% extends 'base.html' %}
{% block content %}
  <div class="text-center text-lg-start mb-4">
    <p class="text-uppercase text-primary fw-bold small mb-2">Step 2 of 3</p>
    <h1 class="fw-bold mb-2">Tell us about you</h1>
    <p class="text-muted mb-0">A complete profile helps us verify your identity and craft repayment terms that match your real cash flow.</p>
  </div>

  {% if form.non_field_errors %}
    <div class="alert alert-danger" role="alert">
      {{ form.non_field_errors|striptags }}
    </div>
  {% endif %}

  <form method="post" novalidate class="needs-validation">
    {% csrf_token %}

    <section class="mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <p class="text-uppercase text-muted small mb-1">Residential footprint</p>
        </div>
        <span class="badge bg-light text-dark fw-semibold">No PO boxes</span>
      </div>
      <div class="row g-3">
        <div class="col-12">
          <label for="{{ form.street_address.id_for_label }}" class="form-label fw-semibold">Street address</label>
          {{ form.street_address }}
          <div class="form-text">Include apartment, suite, or unit number.</div>
          {% if form.street_address.errors %}
            <div class="text-danger small mt-1">{{ form.street_address.errors|striptags }}</div>
          {% endif %}
        </div>
        <div class="col-md-5">
          <label for="{{ form.city.id_for_label }}" class="form-label fw-semibold">City</label>
          {{ form.city }}
          {% if form.city.errors %}
            <div class="text-danger small mt-1">{{ form.city.errors|striptags }}</div>
          {% endif %}
        </div>
        <div class="col-md-4">
          <label for="{{ form.state.id_for_label }}" class="form-label fw-semibold">State / Province</label>
          {{ form.state }}
          {% if form.state.errors %}
            <div class="text-danger small mt-1">{{ form.state.errors|striptags }}</div>
          {% endif %}
        </div>
        <div class="col-md-3">
          <label for="{{ form.postal_code.id_for_label }}" class="form-label fw-semibold">Postal / ZIP</label>
          {{ form.postal_code }}
          {% if form.postal_code.errors %}
            <div class="text-danger small mt-1">{{ form.postal_code.errors|striptags }}</div>
          {% endif %}
        </div>
      </div>
    </section>

    <section class="mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <p class="text-uppercase text-muted small mb-1">Background snapshot</p>
        </div>
      </div>
      <div class="row g-3">
        <div class="col-md-4">
          <label for="{{ form.nationality.id_for_label }}" class="form-label fw-semibold">Nationality</label>
          {{ form.nationality }}
          {% if form.nationality.errors %}
            <div class="text-danger small mt-1">{{ form.nationality.errors|striptags }}</div>
          {% endif %}
        </div>
        <div class="col-md-4">
          <label for="{{ form.marital_status.id_for_label }}" class="form-label fw-semibold">Marital status</label>
          {{ form.marital_status }}
          {% if form.marital_status.errors %}
            <div class="text-danger small mt-1">{{ form.marital_status.errors|striptags }}</div>
          {% endif %}
        </div>
        <div class="col-md-4">
          <label for="{{ form.housing_status.id_for_label }}" class="form-label fw-semibold">House ownership</label>
          {{ form.housing_status }}
          {% if form.housing_status.errors %}
            <div class="text-danger small mt-1">{{ form.housing_status.errors|striptags }}</div>
          {% endif %}
        </div>
      </div>
    </section>

    <section class="mb-4">
      <div class="row g-3">
        <div class="col-md-6">
          <label for="{{ form.dob.id_for_label }}" class="form-label fw-semibold">Date of birth</label>
          {{ form.dob }}
          <div class="form-text">Must be 18 years or older.</div>
          {% if form.dob.errors %}
            <div class="text-danger small mt-1">{{ form.dob.errors|striptags }}</div>
          {% endif %}
        </div>
        <div class="col-md-6">
          <label for="{{ form.employment_status.id_for_label }}" class="form-label fw-semibold">Employment status</label>
          {{ form.employment_status }}
          <div class="form-text">Tell us how you primarily earn income.</div>
          {% if form.employment_status.errors %}
            <div class="text-danger small mt-1">{{ form.employment_status.errors|striptags }}</div>
          {% endif %}
        </div>
      </div>
    </section>

    <section class="mb-4">
      <label for="{{ form.monthly_income.id_for_label }}" class="form-label fw-semibold">Average monthly income</label>
      <div class="input-group input-group-lg shadow-sm">
        <span class="input-group-text bg-white border-end-0">$</span>
        {{ form.monthly_income }}
        <span class="input-group-text bg-white text-muted border-start-0">USD</span>
      </div>
      <div class="d-flex justify-content-between flex-wrap small text-muted mt-2 gap-2">
        <span>Provide your gross monthly income before deductions.</span>
        <span>Displays as <strong data-income-preview>$0.00</strong></span>
      </div>
      {% if form.monthly_income.errors %}
        <div class="text-danger small mt-1">{{ form.monthly_income.errors|striptags }}</div>
      {% endif %}
    </section>

    <button type="submit" class="btn btn-primary w-100 py-3 fw-semibold">Save & continue</button>
  </form>
{% endblock %}

{% block extra_scripts %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const dobInput = document.getElementById('id_dob');
      if (dobInput) {
        const today = new Date();
        today.setFullYear(today.getFullYear() - 18);
        const isoDate = today.toISOString().split('T')[0];
        dobInput.setAttribute('max', isoDate);
      }

      const incomeInput = document.getElementById('id_monthly_income');
      const incomePreview = document.querySelector('[data-income-preview]');
      if (incomeInput && incomePreview) {
        const formatter = new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });

        const updatePreview = () => {
          const raw = incomeInput.value.replace(/[^0-9.]/g, '');
          const numeric = parseFloat(raw);
          incomePreview.textContent = !isNaN(numeric) ? formatter.format(numeric) : '$0.00';
        };

        incomeInput.addEventListener('input', updatePreview);
        updatePreview();
      }
    });
  </script>
{% endblock %}
