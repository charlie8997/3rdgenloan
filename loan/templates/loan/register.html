{% extends 'base.html' %}
{% block extra_head %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.1.1/build/css/intlTelInput.css">
  <style>
    .iti--allow-dropdown {
      width: 100%;
    }
    .iti__flag-container {
      font-size: 0.9rem;
    }
    .pwd-wrapper { position: relative; }
    .pwd-toggle {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      padding: 4px;
      cursor: pointer;
      color: rgba(0,0,0,0.6);
    }
    .pwd-toggle:focus { outline: none; }
    .pwd-toggle svg { width: 18px; height: 18px; }
  </style>
{% endblock %}

{% block content %}
  <h1 class="fw-bold mb-2">Get up to $168,600 today</h1>
  <p class="text-muted mb-4">Same-day funding, 6-24 month terms, and transparent. Licensed Texas private lender.</p>

  <div class="row g-2 mb-4">
    <div class="col-6">
      <div class="p-3 border rounded-4 text-center">
        <div class="text-primary fw-bold">30 min</div>
        <small class="text-muted">Average approval time</small>
      </div>
    </div>
    <div class="col-6">
      <div class="p-3 border rounded-4 text-center">
        <div class="text-primary fw-bold">$4 / $100</div>
        <small class="text-muted">Flat transparent fee</small>
      </div>
    </div>
  </div>


  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-danger fw-bold text-center" role="alert" style="font-size:1.1rem;">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <form method="post" class="needs-validation" novalidate id="registration-form">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <div class="mb-3">
      <label class="form-label fw-semibold">{{ form.full_name.label }}</label>
      {{ form.full_name }}
      {% if form.full_name.errors %}
        <div class="text-danger small">{{ form.full_name.errors|striptags }}</div>
      {% endif %}
    </div>

    <div class="mb-3">
      <label class="form-label fw-semibold">{{ form.email.label }}</label>
      {{ form.email }}
      {% if form.email.errors %}
        <div class="text-danger small">{{ form.email.errors|striptags }}</div>
      {% endif %}
    </div>

    <div class="mb-3">
      <label class="form-label fw-semibold">Mobile number</label>
      {{ form.phone }}
      <small class="text-muted">Tap the flag to pick your country code, then enter the rest of your number.</small>
      {% if form.phone.errors %}
        <div class="text-danger small">{{ form.phone.errors|striptags }}</div>
      {% endif %}
    </div>

    

    <div class="mb-3">
      <label class="form-label fw-semibold">{{ form.password.label }}</label>
      {{ form.password }}
      {% if form.password.errors %}
        <div class="text-danger small">{{ form.password.errors|striptags }}</div>
      {% endif %}
    </div>

    <div class="mb-3">
      <label class="form-label fw-semibold">{{ form.confirm_password.label }}</label>
      {{ form.confirm_password }}
      {% if form.confirm_password.errors %}
        <div class="text-danger small">{{ form.confirm_password.errors|striptags }}</div>
      {% endif %}
    </div>

    <button type="submit" class="btn btn-primary w-100 py-2" aria-live="polite">
      <span class="btn-text">Create my account</span>
      <span class="btn-spinner d-none">
        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        Creating...
      </span>
    </button>
  </form>

  <p class="text-center mt-3 mb-0">Already onboard? <a href="/login/">Log in here</a></p>
  <small class="text-muted d-block text-center">Licensed & regulated by the Texas OCCC. We are not a payday lender.</small>
{% endblock %}

{% block extra_scripts %}
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.1.1/build/js/intlTelInput.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.1.1/build/js/utils.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const phoneInput = document.querySelector('#phone-input');
      if (!phoneInput) return;
      const iti = window.intlTelInput(phoneInput, {
        initialCountry: 'us',
        preferredCountries: ['us','ng', 'gb', 'ca', 'za'],
        separateDialCode: false,
        autoPlaceholder: 'polite',
      });

      // Format phone number as user types
      phoneInput.addEventListener('input', function () {
        let countryData = iti.getSelectedCountryData();
        let raw = phoneInput.value.replace(/\D/g, '');
        let formatted = raw;
        if (countryData.iso2 === 'ng' && raw.length >= 10) {
          formatted = raw.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
        } else if (["us","ca","gb"].includes(countryData.iso2) && raw.length >= 10) {
          formatted = raw.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
        } else if (countryData.iso2 === 'za' && raw.length >= 9) {
          formatted = raw.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
        }
        phoneInput.value = formatted;
      });

      const form = document.getElementById('registration-form');
      form.addEventListener('submit', function (e) {
        // set international phone value if valid
        try {
          if (typeof iti !== 'undefined' && iti.isValidNumber()) {
            phoneInput.value = iti.getNumber();
          }
        } catch (err) { /* ignore */ }

        // show loading UI and prevent double-submit
        const submitBtn = form.querySelector('button[type=submit]');
        if (submitBtn) {
          submitBtn.setAttribute('disabled', 'disabled');
          const text = submitBtn.querySelector('.btn-text');
          const spinner = submitBtn.querySelector('.btn-spinner');
          if (text) text.classList.add('d-none');
          if (spinner) spinner.classList.remove('d-none');
          submitBtn.classList.add('disabled');
        }
      });

      // Password show/hide toggle: inline eye icon at right-end
      const addPasswordToggles = () => {
        const pwdFields = Array.from(document.querySelectorAll('#registration-form input[type=password]'));
        pwdFields.forEach((input) => {
          if (input.closest('.pwd-wrapper')) return;
          const wrapper = document.createElement('div');
          wrapper.className = 'pwd-wrapper';
          input.parentNode.insertBefore(wrapper, input);
          wrapper.appendChild(input);

          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'pwd-toggle';
          btn.setAttribute('aria-label', 'Toggle password visibility');
          btn.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
              <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`;

          btn.addEventListener('click', function () {
            const isPwd = input.type === 'password';
            input.type = isPwd ? 'text' : 'password';
            btn.style.opacity = isPwd ? '0.8' : '0.6';
            input.focus();
          });

          wrapper.appendChild(btn);
        });
      };
      addPasswordToggles();
    });
  </script>
{% endblock %}
